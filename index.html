import React, { useState, useEffect, useCallback } from 'react';
import { initializeApp } from 'firebase/app';
import { getAnalytics } from "firebase/analytics"; // Added
import { 
    getAuth, 
    signInAnonymously, 
    signInWithCustomToken, 
    onAuthStateChanged,
    GoogleAuthProvider,
    signInWithPopup,
    signOut
} from 'firebase/auth';
import {
    getFirestore,
    doc,
    setDoc,
    addDoc,
    getDoc,
    getDocs,
    collection,
    query,
    where,
    Timestamp,
    deleteDoc,
    updateDoc,
    serverTimestamp,
    writeBatch
} from 'firebase/firestore';
import { PlusCircle, Trash2, Edit3, Save, Play, StopCircle, Bell, Clock, BarChart2, Repeat, Weight, Calendar, LogIn, LogOut, User, ListChecks } from 'lucide-react';

// --- Firebase Configuration ---
// User's provided Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyD-0JvjXf2T-ZutQOn3SmNm8f7CnoXnITE",
  authDomain: "fitness-tracker-44c16.firebaseapp.com",
  projectId: "fitness-tracker-44c16",
  storageBucket: "fitness-tracker-44c16.firebasestorage.app", // User provided value
  messagingSenderId: "481225086427",
  appId: "1:481225086427:web:8b0599a50a6b1aa25b83fe",
  measurementId: "G-EMYCMNL6XG"
};


// --- App ID Configuration ---
// This remains for app-specific namespacing within Firestore if needed, separate from Firebase project ID
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-workout-app';

// --- Initialize Firebase ---
let app;
let auth;
let db;
let googleProvider;
let analytics; 

try {
    // Initialize Firebase with the user's specific config
    app = initializeApp(firebaseConfig); 
    auth = getAuth(app);
    db = getFirestore(app);
    googleProvider = new GoogleAuthProvider();
    analytics = getAnalytics(app); // Initialize Analytics
    // import { setLogLevel } from "firebase/firestore"; 
    // setLogLevel('debug'); 
} catch (error) {
    console.error("Critical Error Initializing Firebase:", error);
    // This error is critical. The app might not function.
    // We'll set a global error state if possible, or rely on the useEffect check.
}


// --- Helper Functions ---
const formatDate = (date) => {
    if (!date) return '';
    if (date instanceof Timestamp) {
        return date.toDate().toLocaleDateString();
    }
    return new Date(date).toLocaleDateString();
};

const formatTime = (date) => {
    if (!date) return '';
    if (date instanceof Timestamp) {
        return date.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }
    return new Date(date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
};

const todayDateString = () => new Date().toISOString().split('T')[0];


// --- Main App Component ---
function App() {
    const [currentUser, setCurrentUser] = useState(null);
    const [isAuthReady, setIsAuthReady] = useState(false);

    // Gym Session State (for timed sessions)
    const [currentSession, setCurrentSession] = useState(null); 
    const [sessionElapsedTime, setSessionElapsedTime] = useState(0);

    // Exercise Form State
    const [exerciseName, setExerciseName] = useState('');
    const [exerciseTime, setExerciseTime] = useState('');
    const [sets, setSets] = useState([{ reps: '', weight: '' }]);

    // Data State
    const [todaysWorkouts, setTodaysWorkouts] = useState([]); 
    const [supplementReminders, setSupplementReminders] = useState([]);

    // Supplement Form State
    const [supplementName, setSupplementName] = useState('');
    const [supplementTime, setSupplementTime] = useState('');

    const [isLoading, setIsLoading] = useState(true);
    const [authLoading, setAuthLoading] = useState(true);
    const [error, setError] = useState(null); 
    const [showHistory, setShowHistory] = useState(false);
    const [allWorkoutsHistory, setAllWorkoutsHistory] = useState([]);

    const userId = currentUser?.uid;

    // Effect to handle Firebase initialization errors
    useEffect(() => {
        if (!app || !auth || !db) {
            // This check catches if Firebase services failed to initialize in the try-catch block above.
            setError("Firebase services could not be initialized. Please check your configuration, network, and console for critical errors.");
            setAuthLoading(false);
            setIsAuthReady(true); 
            setIsLoading(false);
        }
    }, []);


    // --- Firebase Auth Effect ---
    useEffect(() => {
        if (!auth) { 
            // If auth isn't initialized, the effect above will set an error.
            // No need to proceed here.
            if (!error) setError("Firebase Auth service is not available."); // Fallback error
            setAuthLoading(false);
            setIsAuthReady(true);
            return;
        }
        const unsubscribe = onAuthStateChanged(auth, async (user) => {
            setAuthLoading(true);
            if (user) {
                setCurrentUser({ uid: user.uid, displayName: user.displayName, email: user.email, photoURL: user.photoURL });
                setIsAuthReady(true); setAuthLoading(false);
            } else {
                // Try custom token sign-in if available (e.g., from platform)
                // The "auth/custom-token-mismatch" error means this token is not valid for the configured Firebase project.
                // The app correctly falls back to Google Sign-In if this fails.
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try { 
                        await signInWithCustomToken(auth, __initial_auth_token); 
                    } 
                    catch (e) { 
                        console.error("Error signing in with custom token (this is expected if token is mismatched for the current Firebase project):", e); 
                        // No need to set a user-facing error here for custom token mismatch,
                        // as the app will proceed to offer Google Sign-In.
                        setCurrentUser(null); 
                        setIsAuthReady(true); 
                        setAuthLoading(false); 
                    }
                } else {
                    setCurrentUser(null); 
                    setIsAuthReady(true); 
                    setAuthLoading(false);
                }
            }
        }, (err) => {
            console.error("Auth state error:", err); setError("Authentication state error: " + err.message);
            setCurrentUser(null); setIsAuthReady(true); setAuthLoading(false); setIsLoading(false);
        });
        return () => unsubscribe();
    }, []); 

    // --- Data Fetching Effects ---
    const fetchTodaysWorkouts = useCallback(async () => {
        if (!isAuthReady || !userId || !db) return;
        setIsLoading(true);
        try {
            const todayStr = todayDateString();
            const workoutsCol = collection(db, `artifacts/${appId}/users/${userId}/dailyWorkouts`);
            const q = query(workoutsCol, where("dateString", "==", todayStr));
            const querySnapshot = await getDocs(q);
            const fetchedWorkouts = [];
            querySnapshot.forEach(doc => fetchedWorkouts.push({ id: doc.id, ...doc.data() }));
            
            fetchedWorkouts.sort((a, b) => (a.startTime?.toMillis() || 0) - (b.startTime?.toMillis() || 0));
            setTodaysWorkouts(fetchedWorkouts);

            const activeTimedSessionFromDb = fetchedWorkouts.find(w => w.isTimedSession && !w.endTime && w.startTime);
            if (activeTimedSessionFromDb) {
                if (!currentSession || currentSession.id !== activeTimedSessionFromDb.id) {
                    setCurrentSession(activeTimedSessionFromDb);
                }
            } else if (currentSession && currentSession.isTimedSession) { 
                setCurrentSession(null);
            }

        } catch (e) {
            console.error("Error fetching today's workouts:", e);
            setError("Failed to load today's workout data. " + e.message);
        } finally {
            setIsLoading(false);
        }
    }, [isAuthReady, userId, currentSession]); 

    const fetchSupplementReminders = useCallback(async () => {
        if (!isAuthReady || !userId || !db) return;
        try {
            const remindersCol = collection(db, `artifacts/${appId}/users/${userId}/supplementReminders`);
            const querySnapshot = await getDocs(remindersCol);
            const fetchedReminders = [];
            querySnapshot.forEach(doc => fetchedReminders.push({ id: doc.id, ...doc.data() }));
            setSupplementReminders(fetchedReminders.sort((a,b) => a.time.localeCompare(b.time)));
        } catch (e) {
            console.error("Error fetching supplement reminders:", e);
            setError("Failed to load supplement reminders. " + e.message);
        } 
    }, [isAuthReady, userId]);

    useEffect(() => {
        if (isAuthReady && userId) {
            fetchTodaysWorkouts();
            fetchSupplementReminders();
        } else if (isAuthReady && !userId) {
            setTodaysWorkouts([]); setSupplementReminders([]); setCurrentSession(null); setAllWorkoutsHistory([]);
            setIsLoading(false); 
        }
    }, [isAuthReady, userId, fetchTodaysWorkouts, fetchSupplementReminders]);

    // --- Session Timer Effect (for timed sessions) ---
    useEffect(() => {
        let timerInterval;
        if (currentSession && currentSession.isTimedSession && currentSession.startTime && !currentSession.endTime) {
            timerInterval = setInterval(() => {
                const start = currentSession.startTime.toDate();
                const now = new Date();
                setSessionElapsedTime(Math.floor((now - start) / 1000));
            }, 1000);
        } else {
            setSessionElapsedTime(0);
        }
        return () => clearInterval(timerInterval);
    }, [currentSession]);

    // --- Auth Handlers ---
    const handleGoogleSignIn = async () => {
        if (!auth || !googleProvider) { setError("Firebase Auth or Google Provider not initialized. Cannot sign in."); return; }
        setAuthLoading(true);
        try { 
            await signInWithPopup(auth, googleProvider); 
            setError(null); // Clear previous errors on successful attempt
        } 
        catch (e) { 
            console.error("Error during Google Sign-In:", e); 
            if (e.code === 'auth/unauthorized-domain') {
                setError("Google Sign-In Error: This domain is not authorized for your Firebase project. Please add it to the authorized domains in your Firebase console (Authentication -> Sign-in method -> Google -> Authorized domains).");
            } else if (e.code === 'auth/popup-closed-by-user') {
                setError("Google Sign-In cancelled by user.");
            } else if (e.code === 'auth/network-request-failed') {
                setError("Network error during Google Sign-In. Please check your internet connection.");
            } else {
                setError("Google Sign-In failed: " + e.message + (e.code ? ` (Code: ${e.code})` : ''));
            }
            setCurrentUser(null); 
            setAuthLoading(false); 
        }
    };
    const handleSignOut = async () => {
        if (!auth) { setError("Firebase Auth not initialized. Cannot sign out."); return; }
        setAuthLoading(true);
        try { 
            await signOut(auth); 
            setCurrentSession(null); setTodaysWorkouts([]); setSupplementReminders([]); setAllWorkoutsHistory([]); 
            setError(null); 
        } 
        catch (e) { console.error("Error signing out:", e); setError("Sign-out failed: " + e.message); } 
        finally { setAuthLoading(false); }
    };

    // --- Timed Gym Session Management ---
    const handleStartSession = async () => {
        if (!userId || !db) { setError("Cannot start session: User not logged in or DB not ready."); return; }
        if (currentSession && currentSession.isTimedSession && !currentSession.endTime) {
            setError("A timed session is already active. Please end it before starting a new one.");
            return;
        }
        const newTimedSession = {
            startTime: Timestamp.now(), exercises: [], dateString: todayDateString(),
            userId: userId, isTimedSession: true, 
        };
        try {
            const workoutsCol = collection(db, `artifacts/${appId}/users/${userId}/dailyWorkouts`);
            const docRef = await addDoc(workoutsCol, newTimedSession);
            const sessionWithId = { ...newTimedSession, id: docRef.id };
            setCurrentSession(sessionWithId); 
            setTodaysWorkouts(prev => [...prev, sessionWithId].sort((a,b) => (a.startTime?.toMillis() || 0) - (b.startTime?.toMillis() || 0)));
            setError(null);
        } catch (e) {
            console.error("Error starting timed session:", e);
            setError("Failed to start timed session. " + e.message);
        }
    };

    const handleEndSession = async () => {
        if (!currentSession || !currentSession.id || !currentSession.isTimedSession || !userId || !db) {
            setError("No active timed session to end or user/db not ready."); return;
        }
        const endTime = Timestamp.now();
        const totalTimeMillis = endTime.toMillis() - currentSession.startTime.toMillis();
        const totalTimeMinutes = Math.floor(totalTimeMillis / (1000 * 60));
        const updatedSessionData = { endTime: endTime, totalTimeMinutes: totalTimeMinutes };
        try {
            const sessionDocRef = doc(db, `artifacts/${appId}/users/${userId}/dailyWorkouts`, currentSession.id);
            await updateDoc(sessionDocRef, updatedSessionData);
            setTodaysWorkouts(prev => prev.map(w => w.id === currentSession.id ? {...w, ...updatedSessionData} : w)
                                      .sort((a,b) => (a.startTime?.toMillis() || 0) - (b.startTime?.toMillis() || 0)));
            setCurrentSession(null); 
            setSessionElapsedTime(0);
            setError(null);
        } catch (e) {
            console.error("Error ending session:", e);
            setError("Failed to save session data. " + e.message);
        }
    };

    // --- Exercise Management (for both timed sessions and general logging) ---
    const handleAddSet = () => setSets([...sets, { reps: '', weight: '' }]);
    const handleSetChange = (index, field, value) => {
        const newSets = [...sets]; newSets[index][field] = value; setSets(newSets);
    };
    const handleRemoveSet = (index) => setSets(sets.filter((_, i) => i !== index));

    const handleAddExercise = async () => {
        if (!exerciseName.trim() || sets.some(s => !String(s.reps).trim() || !String(s.weight).trim())) {
            setError("Please fill in exercise name and complete all sets (reps and weight).");
            return;
        }
        if (!userId || !db) { setError("Cannot log exercise: User not logged in or DB not ready."); return; }

        const newExercise = {
            id: crypto.randomUUID(), name: exerciseName.trim(),
            timeSpentMinutes: parseInt(exerciseTime) || 0,
            sets: sets.map(s => ({ reps: parseInt(s.reps), weight: parseFloat(s.weight) })),
            loggedAt: Timestamp.now()
        };

        try {
            let targetDocId = null;
            let existingExercises = [];
            let workoutDocDataToUpdate; 

            if (currentSession && currentSession.isTimedSession && currentSession.id && !currentSession.endTime) {
                targetDocId = currentSession.id;
                workoutDocDataToUpdate = currentSession; 
                existingExercises = workoutDocDataToUpdate.exercises || [];
            } else {
                const todayStr = todayDateString();
                let generalLogForToday = todaysWorkouts.find(w => w.dateString === todayStr && !w.isTimedSession && !w.endTime);

                if (generalLogForToday) {
                    targetDocId = generalLogForToday.id;
                    workoutDocDataToUpdate = generalLogForToday;
                    existingExercises = workoutDocDataToUpdate.exercises || [];
                } else {
                    const newGeneralLog = {
                        startTime: Timestamp.now(), exercises: [newExercise], dateString: todayStr,
                        userId: userId, isTimedSession: false,
                    };
                    const workoutsCol = collection(db, `artifacts/${appId}/users/${userId}/dailyWorkouts`);
                    const docRef = await addDoc(workoutsCol, newGeneralLog);
                    setTodaysWorkouts(prev => [...prev, {...newGeneralLog, id: docRef.id }].sort((a,b) => (a.startTime?.toMillis() || 0) - (b.startTime?.toMillis() || 0)));
                    setExerciseName(''); setExerciseTime(''); setSets([{ reps: '', weight: '' }]);
                    setError(null);
                    return; 
                }
            }
            
            if (!targetDocId || !workoutDocDataToUpdate) {
                setError("Could not determine target workout log."); return;
            }

            const updatedExercises = [...existingExercises, newExercise].sort((a,b) => (a.loggedAt?.toMillis() || 0) - (b.loggedAt?.toMillis() || 0));
            const workoutDocRef = doc(db, `artifacts/${appId}/users/${userId}/dailyWorkouts`, targetDocId);
            await updateDoc(workoutDocRef, { exercises: updatedExercises });

            if (currentSession && currentSession.id === targetDocId) {
                setCurrentSession(prev => ({ ...prev, exercises: updatedExercises }));
            }
            setTodaysWorkouts(prev => prev.map(w => w.id === targetDocId ? {...w, exercises: updatedExercises} : w)
                                      .sort((a,b) => (a.startTime?.toMillis() || 0) - (b.startTime?.toMillis() || 0)));
            
            setExerciseName(''); setExerciseTime(''); setSets([{ reps: '', weight: '' }]);
            setError(null);

        } catch (e) {
            console.error("Error logging exercise:", e);
            setError("Failed to log exercise: " + e.message);
        }
    };
    
    const handleDeleteExercise = async (workoutDocId, exerciseIdToDelete) => {
        if (!userId || !db || !workoutDocId || !exerciseIdToDelete) {
            setError("Cannot delete exercise: Missing information."); return;
        }
        try {
            const workoutDocRef = doc(db, `artifacts/${appId}/users/${userId}/dailyWorkouts`, workoutDocId);
            const targetWorkoutDoc = todaysWorkouts.find(w => w.id === workoutDocId);

            if (!targetWorkoutDoc || !targetWorkoutDoc.exercises) {
                setError("Workout document not found or has no exercises."); return;
            }
            const updatedExercises = targetWorkoutDoc.exercises.filter(ex => ex.id !== exerciseIdToDelete);
            
            await updateDoc(workoutDocRef, { exercises: updatedExercises });
            if (currentSession && currentSession.id === workoutDocId) {
                setCurrentSession(prev => ({ ...prev, exercises: updatedExercises }));
            }
            setTodaysWorkouts(prev => prev.map(w => w.id === workoutDocId ? {...w, exercises: updatedExercises} : w)
                                      .sort((a,b) => (a.startTime?.toMillis() || 0) - (b.startTime?.toMillis() || 0)));
            setError(null);
        } catch (e) {
            console.error("Error deleting exercise:", e);
            setError("Failed to delete exercise from log. " + e.message);
        }
    };

    // --- Supplement Reminders Management ---
    const handleAddSupplementReminder = async () => {
        if (!supplementName.trim() || !supplementTime) { setError("Please enter supplement name and time."); return; }
        if (!userId || !db) { setError("Cannot add supplement: User not logged in or DB not ready."); return; }
        const newReminder = { userId: userId, name: supplementName.trim(), time: supplementTime, createdAt: serverTimestamp() };
        try {
            const remindersCol = collection(db, `artifacts/${appId}/users/${userId}/supplementReminders`);
            const docRef = await addDoc(remindersCol, newReminder);
            setSupplementReminders(prev => [...prev, { id: docRef.id, ...newReminder }].sort((a,b) => a.time.localeCompare(b.time)));
            setSupplementName(''); setSupplementTime(''); setError(null);
        } catch (e) { console.error("Error adding supplement reminder:", e); setError("Failed to add supplement reminder. " + e.message); }
    };
    const handleDeleteSupplementReminder = async (reminderId) => {
        if (!userId || !db) { setError("Cannot delete supplement: User not logged in or DB not ready."); return; }
        try {
            const reminderDocRef = doc(db, `artifacts/${appId}/users/${userId}/supplementReminders`, reminderId);
            await deleteDoc(reminderDocRef);
            setSupplementReminders(prev => prev.filter(r => r.id !== reminderId));
            setError(null);
        } catch (e) { console.error("Error deleting supplement reminder:", e); setError("Failed to delete supplement reminder. " + e.message); }
    };

    // --- Workout History ---
    const fetchAllWorkoutsHistory = useCallback(async () => {
        if (!isAuthReady || !userId || !db) return;
        setIsLoading(true);
        try {
            const workoutsCol = collection(db, `artifacts/${appId}/users/${userId}/dailyWorkouts`);
            const querySnapshot = await getDocs(workoutsCol);
            let fetchedHistory = [];
            querySnapshot.forEach(doc => fetchedHistory.push({ id: doc.id, ...doc.data() }));
            fetchedHistory.sort((a, b) => {
                const timeA = a.startTime?.toMillis() || (a.dateString ? new Date(a.dateString).getTime() : 0);
                const timeB = b.startTime?.toMillis() || (b.dateString ? new Date(b.dateString).getTime() : 0);
                return timeB - timeA; 
            });
            setAllWorkoutsHistory(fetchedHistory);
        } catch (e) { console.error("Error fetching workout history:", e); setError("Failed to load workout history. " + e.message); } 
        finally { setIsLoading(false); }
    }, [isAuthReady, userId]);

    useEffect(() => {
        if (showHistory && userId) { fetchAllWorkoutsHistory(); }
    }, [showHistory, fetchAllWorkoutsHistory, userId]);

    // --- UI Rendering ---
    const formatElapsedTime = (seconds) => {
        const h = Math.floor(seconds / 3600); const m = Math.floor((seconds % 3600) / 60); const s = seconds % 60;
        return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
    };

    if (!app && !error) { 
         return <div className="min-h-screen bg-gray-900 text-white flex items-center justify-center p-4"><div className="text-xl text-red-500">Critical Error: Firebase application did not initialize. Check console.</div></div>;
    }
    if (authLoading || (!isAuthReady && isLoading)) { 
        return <div className="min-h-screen bg-gray-900 text-white flex items-center justify-center p-4"><div className="text-xl">Loading Fitness Tracker...</div></div>;
    }
    
    const ErrorDisplay = ({ message }) => (
        message && <div className="my-4 p-3 bg-red-600 text-white rounded-md text-center shadow-lg">
            <p>{message}</p> <button onClick={() => setError(null)} className="mt-2 text-sm underline hover:text-red-200">Dismiss</button>
        </div>
    );

    return (
        <div className="min-h-screen bg-gray-900 text-gray-100 font-sans p-4 md:p-8">
            <header className="mb-6 pb-4 border-b border-gray-700">
                <div className="flex flex-col sm:flex-row justify-between items-center">
                    <h1 className="text-4xl md:text-5xl font-bold text-cyan-400">FitTrack Pro</h1>
                    {isAuthReady && currentUser && (
                        <div className="flex items-center mt-4 sm:mt-0">
                            {currentUser.photoURL && <img src={currentUser.photoURL} alt={currentUser.displayName || 'User'} className="w-10 h-10 rounded-full mr-3 border-2 border-cyan-500"/>}
                            <span className="text-sm text-gray-300 mr-4 hidden md:inline">Welcome, {currentUser.displayName || currentUser.email}</span>
                            <button onClick={handleSignOut} className="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg shadow-md transition duration-150 ease-in-out flex items-center">
                                <LogOut size={18} className="mr-2"/> Sign Out
                            </button>
                        </div>
                    )}
                </div>
                {isAuthReady && currentUser && <p className="text-xs text-gray-500 mt-1 text-center sm:text-left">User ID: {currentUser.uid}</p>}
            </header>

            <ErrorDisplay message={error} />

            {!isAuthReady || !currentUser ? (
                <section className="bg-gray-800 p-8 rounded-xl shadow-2xl text-center max-w-md mx-auto">
                    <User size={48} className="mx-auto text-cyan-400 mb-4" />
                    <h2 className="text-2xl font-semibold text-white mb-6">Welcome to FitTrack Pro</h2>
                    <p className="text-gray-300 mb-8">Please sign in with your Google account to track your workouts and supplements.</p>
                    { error && error.includes("Firebase services could not be initialized") ? 
                        <p className="text-red-400 mb-4">App cannot connect to backend services. Please try again later.</p> 
                        :
                        <button onClick={handleGoogleSignIn} disabled={authLoading} className="w-full flex items-center justify-center px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white font-bold rounded-lg shadow-md transition duration-150 ease-in-out disabled:opacity-70 disabled:cursor-not-allowed">
                            <svg className="w-5 h-5 mr-2 fill-current" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M21.8 10.2c0-.7-.1-1.3-.2-2H12v3.8h5.5c-.2 1.2-.8 2.2-1.8 2.9v2.5h3.2c1.9-1.7 3-4.2 3-7.2z"/><path d="M12 22c2.7 0 4.9-.9 6.6-2.4l-3.2-2.5c-.9.6-2 .9-3.4.9-2.6 0-4.8-1.8-5.6-4.2H3.1v2.6C4.8 19.9 8.1 22 12 22z"/><path d="M6.4 13.7c-.2-.6-.2-1.2-.2-1.8s0-1.2.2-1.8V7.6H3.1c-.6 1.2-1 2.6-1 4.2s.4 3 1 4.2l3.3-2.5z"/><path d="M12 6.1c1.4 0 2.7.5 3.7 1.5l2.8-2.8C16.9 3 14.7 2 12 2 8.1 2 4.8 4.1 3.1 6.9l3.3 2.5c.8-2.4 3-4.3 5.6-4.3z"/></svg>
                            Sign In with Google
                        </button>
                    }
                    <p className="text-xs text-gray-500 mt-4">
                        If Google Sign-In fails due to an "unauthorized domain," please ensure your current domain (e.g., localhost) is added to the authorized domains in your Firebase project's Authentication settings.
                    </p>
                     <p className="text-xs text-gray-500 mt-2">
                        If a custom authentication token is being used by the platform, it might not match the configured Firebase project, in which case Google Sign-In is the primary method.
                    </p>
                </section>
            ) : (
                <> {/* Main App Content - only shown if user is logged in */}
                    <div className="mb-6 text-center">
                        <button onClick={() => setShowHistory(!showHistory)} className="px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-lg shadow-md transition duration-150 ease-in-out">
                            {showHistory ? "Show Today's Workout" : "Show Workout History"}
                        </button>
                    </div>

                    {showHistory ? (
                        <section className="bg-gray-800 p-6 rounded-xl shadow-2xl mb-8">
                            <h2 className="text-2xl font-semibold text-cyan-400 mb-4 flex items-center"><Calendar className="mr-2 h-6 w-6" />Workout History</h2>
                            {isLoading && <div className="text-center py-4">Loading history...</div>}
                            {!isLoading && allWorkoutsHistory.length === 0 && <p className="text-gray-400">No past workouts found.</p>}
                            <div className="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                                {allWorkoutsHistory.map(workout => (
                                    <div key={workout.id} className={`p-4 rounded-lg shadow-md ${workout.isTimedSession ? 'bg-gray-700 hover:bg-gray-600/50' : 'bg-gray-700 border-l-4 border-cyan-500 hover:bg-gray-600/50'}`}>
                                        <h3 className="text-xl font-semibold text-cyan-300">
                                            {workout.isTimedSession ? `Session on: ${formatDate(workout.startTime)}` : `Logged Exercises: ${formatDate(workout.startTime || workout.dateString)}`}
                                            {workout.isTimedSession && ` (${formatTime(workout.startTime)} - ${workout.endTime ? formatTime(workout.endTime) : 'In Progress'})`}
                                        </h3>
                                        {workout.isTimedSession && workout.totalTimeMinutes !== undefined && <p className="text-sm text-gray-400">Total Duration: {workout.totalTimeMinutes} minutes</p>}
                                        {!workout.isTimedSession && <p className="text-sm text-gray-400">General Log</p>}
                                        <ul className="mt-2 space-y-1">
                                            {(workout.exercises || []).map(ex => (
                                                <li key={ex.id || crypto.randomUUID()} className="text-sm ml-4 py-1">
                                                    <strong>{ex.name}</strong> ({(ex.timeSpentMinutes || 0)} min) - <span className="text-xs text-gray-500">Logged: {formatTime(ex.loggedAt)}</span>
                                                    <ul className="list-disc ml-6 text-gray-300">
                                                        {ex.sets.map((set, i) => ( <li key={i}>{set.reps} reps @ {set.weight} kg/lbs</li> ))}
                                                    </ul>
                                                </li>
                                            ))}
                                             {(!workout.exercises || workout.exercises.length === 0) && <p className="text-sm text-gray-500 italic ml-4">No exercises in this entry.</p>}
                                        </ul>
                                    </div>
                                ))}
                            </div>
                        </section>
                    ) : ( // Today's View
                        <>
                            {/* Timed Gym Session Control */}
                            <section className="bg-gray-800 p-6 rounded-xl shadow-2xl mb-8">
                                <h2 className="text-2xl font-semibold text-cyan-400 mb-4 flex items-center"><Clock className="mr-2 h-6 w-6" />Timed Gym Session</h2>
                                {!(currentSession && currentSession.isTimedSession && !currentSession.endTime) ? (
                                    <button onClick={handleStartSession} disabled={isLoading || !userId || (currentSession && currentSession.isTimedSession && !currentSession.endTime) } className="w-full flex items-center justify-center px-6 py-3 bg-green-500 hover:bg-green-600 text-white font-bold rounded-lg shadow-md transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed">
                                        <Play className="mr-2 h-5 w-5" /> Start Timed Session
                                    </button>
                                ) : (
                                    <div className="text-center">
                                        <p className="text-3xl font-mono text-yellow-400 mb-4">{formatElapsedTime(sessionElapsedTime)}</p>
                                        <button onClick={handleEndSession} disabled={isLoading || !userId} className="w-full flex items-center justify-center px-6 py-3 bg-red-500 hover:bg-red-600 text-white font-bold rounded-lg shadow-md transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed">
                                            <StopCircle className="mr-2 h-5 w-5" /> End Timed Session
                                        </button>
                                    </div>
                                )}
                                 {(currentSession && currentSession.isTimedSession && !currentSession.endTime) && <p className="text-center text-yellow-500 text-sm mt-2">Timed session is active. Exercises logged will be part of this session.</p>}
                            </section>

                            {/* Add Exercise Form (Always available if logged in) */}
                            <section className="bg-gray-800 p-6 rounded-xl shadow-2xl mb-8">
                                <h2 className="text-2xl font-semibold text-cyan-400 mb-4 flex items-center"><PlusCircle className="mr-2 h-6 w-6" />Log Exercise</h2>
                                <div className="space-y-4">
                                    <div>
                                        <label htmlFor="exerciseName" className="block text-sm font-medium text-gray-300 mb-1">Exercise Name</label>
                                        <input type="text" id="exerciseName" value={exerciseName} onChange={(e) => setExerciseName(e.target.value)} placeholder="e.g., Bench Press" className="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2 focus:ring-cyan-500 focus:border-cyan-500"/>
                                    </div>
                                    <div>
                                        <label htmlFor="exerciseTime" className="block text-sm font-medium text-gray-300 mb-1">Time Spent (minutes, optional)</label>
                                        <input type="number" id="exerciseTime" value={exerciseTime} onChange={(e) => setExerciseTime(e.target.value)} placeholder="e.g., 15" className="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2 focus:ring-cyan-500 focus:border-cyan-500"/>
                                    </div>
                                    <h3 className="text-lg font-medium text-gray-200 pt-2">Sets</h3>
                                    {sets.map((set, index) => (
                                        <div key={index} className="flex items-center space-x-2 p-2 bg-gray-700 rounded-md">
                                            <input type="number" value={set.reps} onChange={(e) => handleSetChange(index, 'reps', e.target.value)} placeholder="Reps" className="w-1/3 bg-gray-600 border border-gray-500 text-white rounded-md p-2 focus:ring-cyan-500 focus:border-cyan-500"/>
                                            <Weight className="text-gray-400 h-5 w-5" />
                                            <input type="number" value={set.weight} onChange={(e) => handleSetChange(index, 'weight', e.target.value)} placeholder="Weight (kg/lbs)" className="w-1/3 bg-gray-600 border border-gray-500 text-white rounded-md p-2 focus:ring-cyan-500 focus:border-cyan-500"/>
                                            {sets.length > 1 && (<button onClick={() => handleRemoveSet(index)} className="text-red-400 hover:text-red-600 p-1"><Trash2 size={18} /></button>)}
                                        </div>
                                    ))}
                                    <div className="flex justify-between items-center">
                                        <button onClick={handleAddSet} className="text-sm text-cyan-400 hover:text-cyan-300 flex items-center">
                                            <PlusCircle size={18} className="mr-1" /> Add Set
                                        </button>
                                        <button onClick={handleAddExercise} disabled={isLoading || !userId} className="px-6 py-2 bg-cyan-500 hover:bg-cyan-600 text-white font-semibold rounded-lg shadow-md transition duration-150 ease-in-out flex items-center disabled:opacity-50 disabled:cursor-not-allowed">
                                            <Save className="mr-2 h-5 w-5" /> Log This Exercise
                                        </button>
                                    </div>
                                </div>
                            </section>

                            {/* Today's Logged Workout - Consolidated View */}
                            <section className="bg-gray-800 p-6 rounded-xl shadow-2xl mb-8">
                                <h2 className="text-2xl font-semibold text-cyan-400 mb-4 flex items-center"><ListChecks className="mr-2 h-6 w-6" />Today's Logged Activities ({todayDateString()})</h2>
                                {isLoading && <div className="text-center py-4">Loading today's activities...</div>}
                                {!isLoading && todaysWorkouts.length === 0 && (<p className="text-gray-400">No activities logged for today yet.</p>)}
                                
                                {todaysWorkouts.map(workoutDoc => (
                                    <div key={workoutDoc.id} className={`mb-6 p-4 rounded-lg shadow-md ${workoutDoc.isTimedSession ? 'bg-gray-700 hover:bg-gray-600/50' : 'bg-gray-700 border-l-4 border-teal-500 hover:bg-gray-600/50'}`}>
                                        {workoutDoc.isTimedSession ? (
                                            <h3 className="text-xl font-medium text-yellow-400 mb-2">
                                                Timed Session ({formatTime(workoutDoc.startTime)} - {workoutDoc.endTime ? formatTime(workoutDoc.endTime) : 'Active'})
                                                {workoutDoc.endTime && <span className="text-sm text-gray-400 ml-2">({workoutDoc.totalTimeMinutes} min)</span>}
                                            </h3>
                                        ) : (
                                            <h3 className="text-xl font-medium text-teal-400 mb-2">
                                                General Log Entry <span className="text-xs text-gray-500">(Logged around: {formatTime(workoutDoc.startTime)})</span>
                                            </h3>
                                        )}
                                        {(workoutDoc.exercises && workoutDoc.exercises.length > 0) ? (
                                            <ul className="space-y-3">
                                                {workoutDoc.exercises.map(ex => (
                                                    <li key={ex.id} className="bg-gray-600 p-3 rounded-lg shadow">
                                                        <div className="flex justify-between items-start">
                                                            <div>
                                                                <p className="font-semibold text-lg text-white">{ex.name}</p>
                                                                <p className="text-sm text-gray-400">Time: {ex.timeSpentMinutes || 0} minutes</p>
                                                                <p className="text-xs text-gray-500">Logged: {formatTime(ex.loggedAt)}</p>
                                                            </div>
                                                            <button onClick={() => handleDeleteExercise(workoutDoc.id, ex.id)} className="text-red-400 hover:text-red-500 p-1">
                                                                <Trash2 size={18} />
                                                            </button>
                                                        </div>
                                                        <ul className="list-disc list-inside ml-2 mt-1 text-sm text-gray-300 space-y-1">
                                                            {ex.sets.map((s, i) => ( <li key={i}>{s.reps} reps @ {s.weight} kg/lbs</li> ))}
                                                        </ul>
                                                    </li>
                                                ))}
                                            </ul>
                                        ) : (
                                            <p className="text-gray-400 italic">No exercises in this entry.</p>
                                        )}
                                    </div>
                                ))}
                            </section>
                        </>
                    )}

                    {/* Supplement Reminders */}
                    <section className="bg-gray-800 p-6 rounded-xl shadow-2xl">
                         <h2 className="text-2xl font-semibold text-cyan-400 mb-4 flex items-center"><Bell className="mr-2 h-6 w-6" />Supplement Reminders</h2>
                        <div className="grid md:grid-cols-2 gap-6">
                            <div>
                                <h3 className="text-lg font-medium text-gray-200 mb-2">Add New Reminder</h3>
                                <div className="space-y-3">
                                    <input type="text" value={supplementName} onChange={(e) => setSupplementName(e.target.value)} placeholder="Supplement Name (e.g., Creatine)" className="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2 focus:ring-cyan-500 focus:border-cyan-500"/>
                                    <input type="time" value={supplementTime} onChange={(e) => setSupplementTime(e.target.value)} className="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2 focus:ring-cyan-500 focus:border-cyan-500"/>
                                    <button onClick={handleAddSupplementReminder} disabled={isLoading || !userId} className="w-full px-4 py-2 bg-indigo-500 hover:bg-indigo-600 text-white font-semibold rounded-lg shadow-md transition duration-150 ease-in-out flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                                        <PlusCircle className="mr-2 h-5 w-5" /> Add Reminder
                                    </button>
                                </div>
                            </div>
                            <div>
                                <h3 className="text-lg font-medium text-gray-200 mb-2">Your Reminders</h3>
                                {isLoading && <div className="text-center py-2">Loading reminders...</div>}
                                {!isLoading && supplementReminders.length === 0 && <p className="text-gray-400">No supplement reminders set.</p>}
                                <ul className="space-y-2 max-h-48 overflow-y-auto pr-1">
                                    {supplementReminders.map(reminder => (
                                        <li key={reminder.id} className="flex justify-between items-center bg-gray-700 hover:bg-gray-600/50 p-3 rounded-lg shadow">
                                            <div>
                                                <p className="font-medium text-white">{reminder.name}</p>
                                                <p className="text-sm text-cyan-300">{reminder.time}</p>
                                            </div>
                                            <button onClick={() => handleDeleteSupplementReminder(reminder.id)} className="text-red-400 hover:text-red-500 p-1"><Trash2 size={18} /></button>
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        </div>
                    </section>
                </>
            )}

            <footer className="mt-12 text-center text-sm text-gray-500">
                <p>&copy; {new Date().getFullYear()} FitTrack Pro. Keep Pushing!</p>
                {!currentUser && isAuthReady && (<p className="mt-2 text-xs">Note to developer: Ensure Google Sign-In is enabled in your Firebase project's Authentication settings, and your current domain is authorized.</p>)}
            </footer>
        </div>
    );
}

export default App;

